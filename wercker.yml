box: node
build:
  steps:
    - script:
        name: echo nodejs information
        code: |
          echo "node version $(node -v) running"
          echo "npm version $(npm -v) running"
    - npm-install
    - npm-test

deploy:
   aws:
    - add-to-known_hosts:
        hostname: $HOST
    - create-file:
      name: write key
      filename: $PRIVATEKEY_PATH
      content: $KEY_PRIVATE
      overwrite: true
      hide-from-log: true
    - script:
      name: stop application
      code: ssh -i $PRIVATEKEY_PATH -l $USER -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no $HOST pm2 stop server
    - script:
      name: transfer application
      code: |
        pwd
        ls -la
        scp -i $PRIVATEKEY_PATH -o StrictHostKeyChecking=no -o UserKnownHostsFile=no aws-test $USER@$HOST:~
    - script:
      name: start application
      code: ssh -i $PRIVATEKEY_PATH -l root -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no $HOST pm2 start ./index.js